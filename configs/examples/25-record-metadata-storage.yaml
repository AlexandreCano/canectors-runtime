# Example: Record Metadata Storage
# This example demonstrates how to use metadata fields to store internal state
# that persists through the pipeline but is excluded from the output request body.

connector:
  name: metadata-storage-example
  version: "1.0.0"
  description: Demonstrates metadata storage for internal state tracking

  input:
    type: httpPolling
    endpoint: https://source.example.com/api/records
    schedule: "*/5 * * * *"
    method: GET
    dataField: data
    authentication:
      type: api-key
      credentials:
        key: "${SOURCE_API_KEY}"
        location: header
        headerName: X-API-Key

  filters:
    # Script filter to add metadata during processing
    - type: script
      script: |
        function transform(record) {
          // Add processing metadata
          record._metadata = record._metadata || {};
          record._metadata.processed_at = new Date().toISOString();
          record._metadata.source_system = "external-api";
          record._metadata.batch_id = "batch-" + Math.random().toString(36).substr(2, 9);
          
          // Add validation flags
          record._metadata.validated = record.email && record.email.includes("@");
          
          // Track original values before transformation
          record._metadata.original = {
            name: record.name,
            timestamp: record.created_at
          };
          
          return record;
        }

    # Mapping filter - metadata is automatically preserved
    - type: mapping
      mappings:
        - source: name
          target: displayName
        - source: email
          target: contactEmail
        - source: created_at
          target: createdAt
          transforms:
            - op: dateFormat
              format: "2006-01-02T15:04:05Z07:00"
      onError: log

    # Condition filter can access metadata for routing
    - type: condition
      expression: "_metadata.validated == true"
      onTrue: continue
      onFalse: skip

  output:
    type: httpRequest
    endpoint: https://target.example.com/api/users
    method: POST
    headers:
      Content-Type: application/json
      # Use metadata in headers
      X-Processed-At: "{{_metadata.processed_at}}"
      X-Source-System: "{{_metadata.source_system}}"
      X-Batch-ID: "{{_metadata.batch_id}}"
    request:
      bodyFrom: record
      # _metadata field is always excluded from request body automatically
      # But can be accessed in templates for headers/URLs
    authentication:
      type: bearer
      credentials:
        token: "${TARGET_API_TOKEN}"
