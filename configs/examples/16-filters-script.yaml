# Script Filter Example
# Demonstrates JavaScript transformations using the Goja engine
# Use case: Complex business logic, calculations, conditional transformations
#
# You can provide the script in two ways:
# 1. Inline: Use 'script' field with JavaScript code (shown below)
# 2. From file: Use 'scriptFile' field with path to a .js file
#    Example: scriptFile: ./scripts/order-transform.js

connector:
  name: script-filter-example
  version: "1.0.0"
  description: Example with JavaScript script filter for complex transformations

  input:
    type: httpPolling
    endpoint: https://api.source.com/orders
    method: GET
    schedule: "*/5 * * * *"

  filters:
    # First filter: Calculate pricing using JavaScript
    - type: script
      script: |
        function transform(record) {
          // Calculate discount based on quantity
          var discount = 0;
          if (record.quantity >= 10) {
            discount = 0.15; // 15% bulk discount
          } else if (record.quantity >= 5) {
            discount = 0.10; // 10% medium order discount
          } else {
            discount = 0.05; // 5% standard discount
          }

          // Calculate totals
          var subtotal = record.price * record.quantity;
          var discountAmount = subtotal * discount;
          var tax = (subtotal - discountAmount) * 0.08; // 8% tax

          // Return enriched record
          return {
            orderId: record.id,
            customerName: record.customer.name,
            items: record.quantity,
            unitPrice: record.price,
            subtotal: subtotal,
            discountPercent: discount * 100,
            discountAmount: Math.round(discountAmount * 100) / 100,
            tax: Math.round(tax * 100) / 100,
            total: Math.round((subtotal - discountAmount + tax) * 100) / 100,
            processedAt: new Date().toISOString()
          };
        }
      onError: skip  # Skip records that fail transformation

    # Second filter: Apply condition to filter out small orders
    - type: condition
      expression: "total >= 100"
      onTrue: continue
      onFalse: skip

    # Third filter: Map to destination format
    - type: mapping
      mappings:
        - source: orderId
          target: external_order_id
        - source: customerName
          target: customer
        - source: total
          target: amount

  output:
    type: httpRequest
    endpoint: https://api.destination.com/invoices
    method: POST

  defaults:
    onError: fail
    timeoutMs: 30000
    retry:
      maxAttempts: 3
      delayMs: 1000
      backoffMultiplier: 2
